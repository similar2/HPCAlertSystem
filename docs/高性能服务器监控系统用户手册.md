# 高性能服务器监控系统用户手册

## 部署

在本系统中，有三类主要的服务器。

- **监控系统服务器**：用于部署我们的监控系统，主要用于展示警报，管理设备。通过`Alertmanager`与`Prometheus`服务器交互。
- **Prometheus服务器**：部署`Prometheus`系统，直接监控多个监控节点，需配置`Prometheus`和`ipmi exporter`
- **监控节点**：每个节点都需要部署`node exporter`，以及运行自定义脚本。

<img src="C:\Users\14396\AppData\Roaming\Typora\typora-user-images\image-20241209104210359.png" alt="image-20241209104210359" style="zoom:50%;" />

### 前期准备

- 下载git仓库中的`/deploy`文件夹，里面有重要的配置文件

### 被监控节点端

#### 部署`node exporter`

1. 首先下载`/collectors`文件夹，里面有必要的脚本。

2. 在每个节点上都运行`collect_metrics.sh`自定义脚本，来收集node exporter无法收集的metrics。metrics文件的默认位置为`./metrics`。通过运行这段脚本，会在此文件夹下产生多个`.prom`文件。请留意`metrics`文件夹的位置，我们需要用它来配置node exporter。

3. 下载并配置node exporter

   - 如果有docker环境，可以使用`collectors/docker-compose.yml`来配置。注意，

     ```yaml
         volumes:
           - /proc:/host/proc:ro
           - /sys:/host/sys:ro
           - /:/rootfs:ro
           - ./metrics:/metrics:ro  #change this line to actual path of metrics files
           - <actual path to the custom metrics directory>:/metrics:ro  
     ```

   - 没有docker环境的情况下，请从官网下载二进制文件

     1. 下载安装教程如下 https://prometheus.io/docs/guides/node-exporter/#installing-and-running-the-node-exporter。 注意，对于被监控的服务器，只需要安装node exporter，不需要配置Prometheus。
     
     2. 下载安装完成node exporter后，启动node exporter
        1. 手动启动情况下，在安装目录下使用命令  
           - `./node_exporter --collector.textfile.directory=<actual path to /metrics>`
           
        2. 使用systemd来运行的话，需更改配置文件
           - `sudo nano /etc/systemd/system/node_exporter.service`
           
             ```bash
             [Unit]
             Description=Node Exporter
             After=network.target
             
             [Service]
             User=node_exporter
             ExecStart=/usr/local/bin/node_exporter --collector.textfile.directory=/<actual path to /metrics>
             Restart=always
             
             [Install]
             WantedBy=multi-user.target
             
             ```
           
           - 并且重启服务
           
             - `sudo systemctl daemon-reload`
             - `sudo systemctl start node_exporter`
             - 如果需要的话，`sudo systemctl enable node_exporter` ,使得node exporter会在主机启动后自动启动
             - 检查`sudo systemctl status node_exporter`是否为active

4. 测试node exporter

   1. 首先打开http://localhost:9100/metrics, 检查是否有数据。应有类似如下数据

      ```bash
      # HELP go_gc_duration_seconds A summary of the GC invocation durations.
      # TYPE go_gc_duration_seconds summary
      go_gc_duration_seconds{quantile="0"} 3.8996e-05
      go_gc_duration_seconds{quantile="0.25"} 4.5926e-05
      go_gc_duration_seconds{quantile="0.5"} 5.846e-05
      # etc.
      ```

   2. 然后检查自定义监控脚本是否正确运行？

      1. 首先检查是否产生`/metrics`文件夹，以及里面是否存在`.prom`文件。如果`collect_metrics.sh`脚本运行正常，这些文件的内容应该会实时更新。
      2. 然后检查node  exporter运行过程中是否有报错
         - `sudo journalctl -u node_exporter`
3. 最后，检查http://localhost:9100/metrics里是否正确显示自定义metrics。如果没有对`collect_metrics.sh`脚本改动，应该会有`logged_in_user` 和`gpu_utilization`等metrics

### Prometheus服务器端

#### 部署`ipmi exporter`

[官方文档](https://github.com/prometheus-community/ipmi_exporter)

- 通过二进制文件

  - 从[官方发行网站](https://github.com/prometheus-community/ipmi_exporter/releases)下载最新的，适配服务器系统的`.tar.gz`文件。提取文件内容，`tar -xvzf ipmi_exporter.tar.gz`
  - 随后，将文件移到`/usr/local/bin`文件夹，`sudo mv ipmi_exporter /usr/local/bin/`
  - 创建systemd服务文件,`sudo nano /etc/systemd/system/ipmi_exporter.service`, 内容如下

  ```bash
  [Unit]
  Description=IPMI Exporter
  After=network.target
  
  [Service]
  ExecStart=/usr/local/bin/ipmi_exporter --config.file=<actual path to ipmi-exporter.yml>
  Restart=always
  
  [Install]
  WantedBy=multi-user.target
  
  ```

  - 重启服务

- 通过docker
- 安装测试
  - 安装完成后，我们可以通过打开[网址](http://localhost:9290)来测试是否正确运行。
  - 随后，我们需要在Prometheus中配置监控对象，以及一些其他配置。我们会在下个部分介绍。

### 部署`Prometheus`

- 通过二进制文件

  - 通过[官方下载网站](https://prometheus.io/download/)下载适配的`.tar.gz`文件。
  - 同上，配置systemd文件

  ```bash
  [Unit]
  Description=Prometheus Monitoring System
  After=network.target
  
  [Service]
  User=prometheus
  Group=prometheus
  ExecStart=/usr/local/bin/prometheus \
      --config.file=<actual path to ur /prometheus.yml> \
      --web.enable-lifecycle \
  Restart=always
  
  [Install]
  WantedBy=multi-user.target
  ```

  - 同时，我们需要配置`targets.yaml`和`rule.yaml`。这两个文件都被包含在`deploy`文件夹中

    - `targets.yaml`: 我们需要更改为监控节点的bmc服务器地址，用于`ipmi exporter`来收集bmc信息，例如

    ```bash
    - targets: [11.11.3.101, 11.11.3.102, 11.11.3.103, 11.11.3.104]
      labels: {job: ipmi_exporter}
    ```

    - `rule.yaml`: 我们可以修改，来自定义规则

  - 在`prometheus.yaml`中，我们需要包含这两个配置文件的位置。

  ```bash
  # Rules and alerts are read from the specified file(s)
  rule_files:
    - <actual path to rule.yaml>
    ...
    
  scrape_configs:
    - job_name: ipmi
      params:
        module: [ 'default' ]
      # scrape_interval: 10s
      metrics_path: /ipmi
      scheme: http
      file_sd_configs:
        - files:
            - <actual path to tartgets.yaml>
  
  ```

- 安装测试

  - 安装完成后，我们可以通过打开[网址](http://localhost:9090)来测试是否正确运行。
  - 我们可以到[规则界面](http://localhost:9090/rule)和[目标界面](http://localhost:9090/targets?search=)来检测是否正确配置


### 监控主机端